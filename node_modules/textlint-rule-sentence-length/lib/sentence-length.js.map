{"version":3,"file":"sentence-length.js","names":["_sentenceSplitter","require","_textlintUtilToString","_textlintRuleHelper","_regexpStringMatcher","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","obj","key","value","_toPropertyKey","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","removeRangeFromString","text","regExpStrings","patterns","map","pattern","createRegExp","result","replace","defaultOptions","max","skipPatterns","skipUrlStringLink","exclusionPatterns","countBy","isSentenceNode","node","type","SentenceSplitterSyntax","Sentence","strLenByCodeUnits","s","strLenByCodePoints","i","_","reporter","context","_options$max","_ref","_options$skipPatterns","_options$skipUrlStrin","options","maxLength","strLen","helper","RuleHelper","Syntax","RuleError","report","isUrlStringLink","Link","linkNode","nodeText","StringSource","toString","url","Document","Paragraph","isChildNode","BlockQuote","isChildrenSingleLinkNode","children","sentenceRootNode","splitAST","sentence","filteredSentence","sentenceChildNode","source","actualText","sentenceText","actualTextLength","sentenceLength","startLine","loc","start","line","concat","_default","exports","default"],"sources":["../src/sentence-length.ts"],"sourcesContent":["import type { TextlintRuleReporter } from \"@textlint/types\";\nimport type { TxtParentNode } from \"@textlint/ast-node-types\";\nimport type { TxtParentNodeWithSentenceNodeContent, TxtSentenceNodeChildren } from \"sentence-splitter\";\nimport { SentenceSplitterSyntax, splitAST, TxtSentenceNode } from \"sentence-splitter\";\nimport { StringSource } from \"textlint-util-to-string\";\nimport { RuleHelper } from \"textlint-rule-helper\";\nimport { createRegExp } from \"@textlint/regexp-string-matcher\";\n\nfunction removeRangeFromString(text: string, regExpStrings: string[]) {\n    const patterns = regExpStrings.map((pattern) => {\n        return createRegExp(pattern);\n    });\n    let result = text;\n    patterns.forEach((pattern) => {\n        result = result.replace(pattern, \"\");\n    });\n    return result;\n}\n\nexport type Options = {\n    max?: number;\n    /**\n     * The strings that match following patterns is un-count of the sentence\n     * See https://github.com/textlint/regexp-string-matcher\n     */\n    skipPatterns?: string[];\n    /**\n     * If it is true, skip the count of following link node.\n     *\n     * [https://example.com](https://example.com)\n     * <https://example.com>\n     *\n     * UrlStringLink is has the title which is same of href.\n     */\n    skipUrlStringLink?: boolean;\n    /**\n     * @deprecated use skipPatterns\n     */\n    exclusionPatterns?: string[];\n    /**\n     * Determine how to count string length.\n     * By default or set to \"codeunits\", count string by UTF-16 code unit(= using `String.prototype.length`).\n     * If set to \"codepoints\", count string by codepoint.\n     */\n    countBy?: \"codeunits\" | \"codepoints\";\n};\nconst defaultOptions: Required<Options> = {\n    max: 100,\n    skipPatterns: [],\n    skipUrlStringLink: true,\n    /**\n     * @deprecated\n     */\n    exclusionPatterns: [],\n    countBy: \"codeunits\"\n};\n\nconst isSentenceNode = (node: TxtParentNodeWithSentenceNodeContent): node is TxtSentenceNode => {\n    return node.type === SentenceSplitterSyntax.Sentence;\n};\n\n/**\n * A count of the number of code units currently in the string.\n * @param s string\n */\nconst strLenByCodeUnits = (s: string): number => s.length;\n/**\n * A count of the number of codepoint currently in the string.\n *\n * Complexity: O(n)\n * @param s string\n */\nconst strLenByCodePoints = (s: string): number => {\n    let i = 0;\n    for (const _ of s) {\n        ++i;\n    }\n    return i;\n};\nconst reporter: TextlintRuleReporter<Options> = (context, options = {}) => {\n    const maxLength = options.max ?? defaultOptions.max;\n    const skipPatterns = options.skipPatterns ?? options.exclusionPatterns ?? defaultOptions.skipPatterns;\n    const skipUrlStringLink = options.skipUrlStringLink ?? defaultOptions.skipUrlStringLink;\n    const strLen = options.countBy == null || options.countBy === \"codeunits\" ? strLenByCodeUnits : strLenByCodePoints;\n    const helper = new RuleHelper(context);\n    const { Syntax, RuleError, report } = context;\n    const isUrlStringLink = (node: TxtSentenceNodeChildren): boolean => {\n        if (node.type !== Syntax.Link) {\n            return false;\n        }\n        const linkNode = node as TxtParentNode;\n        const nodeText = new StringSource(linkNode).toString();\n        return node.url === nodeText;\n    };\n    // toPlainText\n    return {\n        [Syntax.Document](node) {\n            if (options.exclusionPatterns) {\n                report(node, new RuleError(\"exclusionPatterns is deprecated. Use skipPatterns instead.\"));\n            }\n        },\n        [Syntax.Paragraph](node) {\n            if (helper.isChildNode(node, [Syntax.BlockQuote])) {\n                return;\n            }\n            // If a single Link node in the paragraph node, should be ignore the link length\n            const isChildrenSingleLinkNode = node.children.length === 1 && node.children[0].type === Syntax.Link;\n            if (isChildrenSingleLinkNode) {\n                return;\n            }\n            // empty break line == split sentence\n            const sentenceRootNode = splitAST(node);\n            sentenceRootNode.children.filter(isSentenceNode).forEach((sentence) => {\n                const filteredSentence = skipUrlStringLink\n                    ? {\n                          ...sentence,\n                          children: sentence.children.filter((sentenceChildNode) => {\n                              return !isUrlStringLink(sentenceChildNode);\n                          })\n                      }\n                    : sentence;\n                const source = new StringSource(filteredSentence);\n                const actualText = source.toString();\n                const sentenceText = removeRangeFromString(actualText, skipPatterns);\n                // larger than > 100\n                const actualTextLength = strLen(actualText);\n                const sentenceLength = strLen(sentenceText);\n                if (sentenceLength > maxLength) {\n                    const startLine = filteredSentence.loc.start.line;\n                    report(\n                        // @ts-expect-error: It is compatible with textlint node\n                        filteredSentence,\n                        new RuleError(`Line ${startLine} sentence length(${\n                            sentenceLength !== actualTextLength\n                                ? `${sentenceLength}, original:${actualTextLength}`\n                                : sentenceLength\n                        }) exceeds the maximum sentence length of ${maxLength}.\nOver ${sentenceLength - maxLength} characters.`)\n                    );\n                }\n            });\n        }\n    };\n};\nexport default reporter;\n"],"mappings":"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"}