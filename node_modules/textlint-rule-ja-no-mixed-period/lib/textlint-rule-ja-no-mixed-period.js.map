{"version":3,"file":"textlint-rule-ja-no-mixed-period.js","names":["japaneseRegExp","classicPeriodMarkPattern","defaultOptions","periodMark","allowPeriodMarks","allowEmojiAtEnd","forceAppendPeriod","checkFootnote","reporter","context","options","Syntax","RuleError","report","fixer","getSource","helper","RuleHelper","preferPeriodMark","concat","undefined","FootnoteNodes","defaultIgnoredNodeTypes","ListItem","Link","Code","Image","BlockQuote","Emphasis","ignoredNodeTypes","Paragraph","node","isChildNode","lastNode","children","length","type","Str","lastStrText","test","valid","index","checkEndsWithPeriod","periodMarks","allowEmoji","fix","replaceTextRange","linter"],"sources":["../src/textlint-rule-ja-no-mixed-period.ts"],"sourcesContent":["// LICENSE : MIT\n\"use strict\";\nimport { checkEndsWithPeriod } from \"check-ends-with-period\";\nimport { RuleHelper } from \"textlint-rule-helper\";\nimport type { TextlintRuleReporter } from \"@textlint/types\";\n\nconst japaneseRegExp =\n    /(?:[々〇〻\\u3400-\\u4DBF\\u4E00-\\u9FFF\\uF900-\\uFAFF]|[\\uD840-\\uD87F][\\uDC00-\\uDFFF]|[ぁ-んァ-ヶ])/;\n/***\n * 典型的な句点のパターン\n * これは`periodMark`と交換しても違和感がないものを登録\n * @type {RegExp}\n */\nconst classicPeriodMarkPattern = /[。\\.]/;\n\nconst defaultOptions = {\n    // 優先する句点文字\n    periodMark: \"。\",\n    // 句点文字として許可する文字列の配列\n    // 例外として許可したい文字列を設定する\n    // `periodMark`に指定したものは自動的に許可リストに加わる\n    allowPeriodMarks: [],\n    // 末尾に絵文字を置くことを許可するか\n    allowEmojiAtEnd: false,\n    // 句点で終わって無い場合に`periodMark`を--fix時に追加するかどうか\n    // デフォルトでは自動的に追加しない\n    forceAppendPeriod: false,\n    // [Note] このオプションは標準外なので隠しオプション扱い\n    // [Warning] このオプションはsemverの範囲外なのでいつでも壊れる可能性がある\n    // 脚注はチェック対象から外すかどうか(実質Re:View向け)\n    // デフォルトでは脚注構文(Re:View)は無視する\n    checkFootnote: false\n};\nexport type Options = {\n    // 優先する句点文字\n    periodMark?: string;\n    allowPeriodMarks?: string[];\n    allowEmojiAtEnd?: boolean;\n    forceAppendPeriod?: boolean;\n    checkFootnote?: boolean;\n};\nconst reporter: TextlintRuleReporter<Options> = (context, options = {}) => {\n    const { Syntax, RuleError, report, fixer, getSource } = context;\n    const helper = new RuleHelper(context);\n    // 優先する句点記号\n    const preferPeriodMark = options.periodMark || defaultOptions.periodMark;\n    // 優先する句点記号は常に句点として許可される\n    const allowPeriodMarks = (options.allowPeriodMarks || defaultOptions.allowPeriodMarks).concat(preferPeriodMark);\n    const allowEmojiAtEnd =\n        options.allowEmojiAtEnd !== undefined ? options.allowEmojiAtEnd : defaultOptions.allowEmojiAtEnd;\n    const forceAppendPeriod =\n        options.forceAppendPeriod !== undefined ? options.forceAppendPeriod : defaultOptions.forceAppendPeriod;\n    // [Note] Un-document option\n    const checkFootnote = options.checkFootnote !== undefined ? options.checkFootnote : defaultOptions.checkFootnote;\n    // 脚注のNode Typeを定義(TxtASTの定義外)\n    const FootnoteNodes = [\n        // https://github.com/orangain/textlint-plugin-review\n        \"Footnote\",\n        // https://github.com/textlint/textlint/blob/master/packages/%40textlint/markdown-to-ast/src/mapping/markdown-syntax-map.js\n        // 実際にはmarkdown-to-astではこれはParagraphを含まないInlineNodeなのであまり意味はない\n        \"Definition\",\n        \"footnoteDefinition\" // micromark\n    ];\n    const defaultIgnoredNodeTypes = [\n        Syntax.ListItem,\n        Syntax.Link,\n        Syntax.Code,\n        Syntax.Image,\n        Syntax.BlockQuote,\n        Syntax.Emphasis\n    ];\n    // @ts-expect-error: FootnoteNodes is not defined in textlint types\n    const ignoredNodeTypes = defaultIgnoredNodeTypes.concat(checkFootnote ? [] : FootnoteNodes);\n    return {\n        [Syntax.Paragraph](node) {\n            if (helper.isChildNode(node, ignoredNodeTypes)) {\n                return;\n            }\n            const lastNode = node.children[node.children.length - 1];\n            if (lastNode === undefined || lastNode.type !== Syntax.Str) {\n                return;\n            }\n            const lastStrText = getSource(lastNode);\n            if (lastStrText.length === 0) {\n                return;\n            }\n            // 日本語が含まれていない文章は無視する\n            if (!japaneseRegExp.test(lastStrText)) {\n                return;\n            }\n            const { valid, periodMark, index } = checkEndsWithPeriod(lastStrText, {\n                periodMarks: allowPeriodMarks,\n                allowEmoji: allowEmojiAtEnd\n            });\n            // 問題が無い場合は何もしない\n            if (valid) {\n                return;\n            }\n            // 文末がスペースである場合はスペースを削除する\n            if (/\\s/.test(periodMark)) {\n                report(\n                    lastNode,\n                    new RuleError(`文末が\"${preferPeriodMark}\"で終わっていません。末尾に不要なスペースがあります。`, {\n                        index,\n                        fix: fixer.replaceTextRange([index, index + periodMark.length], \"\")\n                    })\n                );\n                return;\n            }\n            // 典型的なパターンは自動的に`preferPeriodMark`に置き換える\n            // 例) \".\" であるなら \"。\"に変換\n            if (classicPeriodMarkPattern.test(periodMark)) {\n                report(\n                    lastNode,\n                    new RuleError(`文末が\"${preferPeriodMark}\"で終わっていません。`, {\n                        index: index,\n                        fix: fixer.replaceTextRange([index, index + preferPeriodMark.length], preferPeriodMark)\n                    })\n                );\n            } else {\n                // 句点を忘れているパターン\n                if (forceAppendPeriod) {\n                    // `forceAppendPeriod`のオプションがtrueならば、自動で句点を追加する。\n                    report(\n                        lastNode,\n                        new RuleError(`文末が\"${preferPeriodMark}\"で終わっていません。`, {\n                            index: index,\n                            fix: fixer.replaceTextRange([index + 1, index + 1], preferPeriodMark)\n                        })\n                    );\n                } else {\n                    report(\n                        lastNode,\n                        new RuleError(`文末が\"${preferPeriodMark}\"で終わっていません。`, {\n                            index: index\n                        })\n                    );\n                }\n            }\n        }\n    };\n};\n\nexport default {\n    linter: reporter,\n    fixer: reporter\n};\n"],"mappings":"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"}