{"version":3,"file":"MixedChecker.js","names":["Object","defineProperty","exports","value","default","_analyzeDesumasuDearu","require","MixedChecker","constructor","context","options","dearuCount","desumasuCount","dearuHitList","desumasuHitList","_queue","Promise","resolve","check","node","text","then","analyzeOptions","ignoreConjunction","isStrict","analyze","results","retDearu","filter","isDearu","retDesumasu","isDesumasu","length","push","matches","checkout","ignoreManger","isOver","RuleError","report","overType","getOverType","overHitList","forEach","lastHitNode","token","hitIndex","range","index","isIgnoredIndex","ruleError","outputMessage","preferDesumasu","preferDearu","topMessage"],"sources":["../src/MixedChecker.js"],"sourcesContent":["// LICENSE : MIT\n\"use strict\";\nimport { analyze, isDearu, isDesumasu } from \"analyze-desumasu-dearu\";\n\nexport default class MixedChecker {\n    /**\n     * @param context\n     * @param {{preferDearu:boolean, preferDesumasu: boolean}} options\n     */\n    constructor(context, options) {\n        this.context = context;\n        /**\n         * 明示的な優先するタイプの指定\n         * @type {{preferDearu: boolean, preferDesumasu: boolean, isStrict: boolean}}\n         */\n        this.options = options;\n        this.dearuCount = 0;\n        this.desumasuCount = 0;\n        this.dearuHitList = [];\n        this.desumasuHitList = [];\n        this._queue = Promise.resolve();\n    }\n\n    check(node, text) {\n        this._queue = this._queue.then(() => {\n            const analyzeOptions = {\n                ignoreConjunction: !this.options.isStrict\n            };\n            return analyze(text, analyzeOptions).then((results) => {\n                const retDearu = results.filter(isDearu);\n                const retDesumasu = results.filter(isDesumasu);\n                const dearuCount = this.dearuCount + retDearu.length;\n                const desumasuCount = this.desumasuCount + retDesumasu.length;\n                if (this.dearuCount !== dearuCount) {\n                    this.dearuCount = dearuCount;\n                    this.dearuHitList.push({\n                        node,\n                        matches: retDearu\n                    });\n                }\n                if (this.desumasuCount !== desumasuCount) {\n                    this.desumasuCount = desumasuCount;\n                    this.desumasuHitList.push({\n                        node,\n                        matches: retDesumasu\n                    });\n                }\n            });\n        });\n    }\n\n    /**\n     * @param {IgnoreManger}ignoreManger\n     * @returns {Promise.<TResult>}\n     */\n    checkout(ignoreManger) {\n        return this._queue.then(() => {\n            if (!this.isOver()) {\n                return;\n            }\n            const RuleError = this.context.RuleError;\n            const report = this.context.report;\n            const overType = this.getOverType();\n            const overHitList = this.overHitList(overType);\n            // List\n            overHitList.forEach(({ node, matches }) => {\n                // Node\n                const lastHitNode = node;\n                // Tokens\n                matches.forEach((token) => {\n                    const hitIndex = node.range[0] + token.index;\n                    if (ignoreManger.isIgnoredIndex(hitIndex)) {\n                        return;\n                    }\n\n                    const ruleError = new RuleError(this.outputMessage(token), {\n                        index: token.index\n                    });\n                    report(lastHitNode, ruleError);\n                });\n            });\n        });\n    }\n\n    isOver() {\n        if (this.options.preferDesumasu) {\n            return this.dearuCount !== 0;\n        } else if (this.options.preferDearu) {\n            return this.desumasuCount !== 0;\n        }\n        return this.dearuCount !== 0 && this.desumasuCount !== 0;\n    }\n\n    /**\n     * 優先するtypeを返します。\n     * @returns {*}\n     */\n    getOverType() {\n        if (this.options.preferDearu) {\n            return \"である\";\n        } else if (this.options.preferDesumasu) {\n            return \"ですます\";\n        }\n        if (this.dearuCount > this.desumasuCount) {\n            return \"である\";\n        } else {\n            return \"ですます\";\n        }\n    }\n\n    /**\n     * hist node list\n     * @param overType\n     * @returns {Array}\n     */\n    overHitList(overType) {\n        if (overType === \"である\") {\n            return this.desumasuHitList;\n        } else if (overType === \"ですます\") {\n            return this.dearuHitList;\n        }\n    }\n\n    /**\n     * create message string\n     * @param token\n     * @returns {string}\n     */\n    outputMessage(token) {\n        const overType = this.getOverType();\n        let topMessage = \"\";\n        if (overType === \"である\") {\n            // である優先 => 最後の\"ですます\"を表示\n            if (this.options.preferDearu) {\n                // である優先が指定されている場合\n                topMessage = `\"である\"調 でなければなりません\n=> \"である\"調 であるべき箇所に、次の \"ですます\"調 の箇所があります`;\n            } else {\n                topMessage = `\"である\"調 と \"ですます\"調 が混在\n=> \"である\"調 の文体に、次の \"ですます\"調 の箇所があります`;\n            }\n        } else if (overType === \"ですます\") {\n            // ですます優先 => 最後の\"である\"を表示\n            if (this.options.preferDesumasu) {\n                // ですます優先が指定されている場合\n                topMessage = `\"ですます\"調 でなければなりません\n=> \"ですます\"調 であるべき箇所に、次の \"である\"調 の箇所があります`;\n            } else {\n                topMessage = `\"である\"調 と \"ですます\"調 が混在\n=> \"ですます\"調 の文体に、次の \"である\"調 の箇所があります`;\n            }\n        }\n        return `${topMessage}: \"${token.value}\"\nTotal:\nである  : ${this.dearuCount}\nですます: ${this.desumasuCount}\n`;\n    }\n}\n"],"mappings":"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","ignoreList":[]}